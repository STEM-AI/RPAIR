<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Timer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        #timer {
            font-size: 2em;
            margin-top: 20px;
        }
        #startButton, #pauseButton, #resumeButton, #restartButton, #submitScoreButton {
            font-size: 1.5em;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        #startButton:disabled, #pauseButton:disabled, #resumeButton:disabled, #restartButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #gameIdInput, #scoreInput {
            font-size: 1.2em;
            padding: 5px;
            margin-bottom: 10px;
        }
        #scoreInputContainer {
            display: none; 
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Game Timer</h1>
    <input type="number" id="gameIdInput" placeholder="Enter Game ID">
    <button id="startButton" onclick="startGame()">Start Game</button>
    <button id="pauseButton" onclick="pauseGame()" disabled>Pause Game</button>
    <button id="resumeButton" onclick="resumeGame()" disabled>Resume Game</button>
    <button id="restartButton" onclick="restartGame()" disabled>Restart Game</button>

    <div id="timer">Remaining Time: 60</div>

    <div id="scoreInputContainer">
        <input type="number" id="scoreInput" placeholder="Enter Score">
        <button id="submitScoreButton" onclick="submitScore()">Submit Score</button>
    </div>

    <script>
        const eventName = "stem";
        let socket;
        let gameId;
        let gameActive = false;
        let gamePaused = false;

        function startGame() {
            if (gameActive) return; 
            gameActive = true;

            gameId = document.getElementById("gameIdInput").value;
            if (!gameId) {
                alert("Please enter a valid Game ID.");
                return;
            }

            document.getElementById("startButton").disabled = true;
            document.getElementById("pauseButton").disabled = false;
            document.getElementById("restartButton").disabled = false;
            document.getElementById("startButton").textContent = "Game Started";

            socket = new WebSocket(`ws://${window.location.host}/ws/competition_event/${eventName}/game/${gameId}/`);

            socket.onopen = () => {
                console.log("WebSocket connection established");
                socket.send(JSON.stringify({
                    action: "start_game",
                    event_name: eventName,
                    game_id: gameId,
                }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Received message:", data);

                if (data.status === "paused") {
                    document.getElementById("timer").textContent = "Game Paused";
                    gamePaused = true;
                    document.getElementById("pauseButton").disabled = true;
                    document.getElementById("resumeButton").disabled = false;
                    return;
                }

                if (data.status === "resume") {
                    document.getElementById("timer").textContent = "Game Resumed";
                    gamePaused = false;
                    document.getElementById("pauseButton").disabled = false;
                    document.getElementById("resumeButton").disabled = true;
                    return;
                }

                if (data.remaining_time !== undefined) {
                    document.getElementById("timer").textContent = `Remaining Time: ${Math.round(data.remaining_time)} seconds`;

                    if (data.remaining_time <= 0) {
                        document.getElementById("scoreInputContainer").style.display = "block";
                        document.getElementById("startButton").disabled = false;
                        document.getElementById("pauseButton").disabled = true;
                        document.getElementById("resumeButton").disabled = true;
                        document.getElementById("restartButton").disabled = false;
                        document.getElementById("startButton").textContent = "Start Game";
                        gameActive = false;
                    }
                }
            };

            socket.onerror = (error) => console.error("WebSocket error:", error);
            socket.onclose = () => console.log("WebSocket connection closed");
        }

        function pauseGame() {
            if (!gameActive || gamePaused) return;

            socket.send(JSON.stringify({
                action: "pause_game",
                event_name: eventName,
                game_id: gameId,
            }));

            document.getElementById("pauseButton").disabled = true;
            document.getElementById("resumeButton").disabled = false;
            console.log("Pause request sent");
        }

        function resumeGame() {
            if (!gameActive || !gamePaused) return;

            socket.send(JSON.stringify({
                action: "resume_game",
                event_name: eventName,
                game_id: gameId,
            }));

            document.getElementById("pauseButton").disabled = false;
            document.getElementById("resumeButton").disabled = true;
            console.log("Resume request sent");
        }

        function restartGame() {
            if (!gameId) {
                alert("Game ID is missing. Start a game first.");
                return;
            }

            socket.send(JSON.stringify({
                action: "restart_game",
                event_name: eventName,
                game_id: gameId,
            }));

            document.getElementById("timer").textContent = "Restarting Game...";
            document.getElementById("pauseButton").disabled = false;
            document.getElementById("resumeButton").disabled = true;
            document.getElementById("restartButton").disabled = false;
            document.getElementById("scoreInputContainer").style.display = "none";

            console.log("Restart request sent");
        }

        function submitScore() {
            const scoreInput = document.getElementById("scoreInput");
            const score = scoreInput.value;
            const authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQzNzYzMzU5LCJpYXQiOjE3NDM3NTk3NTksImp0aSI6ImM5NjVhZjhmYTJmZjRiNTg5Zjc3YjMxZjhlY2FjOWVjIiwidXNlcl9pZCI6MywidXNlcm5hbWUiOiJuZWtsYXdpIiwiaXNfc3RhZmYiOnRydWUsImlzX3N1cGVydXNlciI6dHJ1ZX0.Y9qhlpoMyZRdJim3HZYiCZonRdYWsBzuLbfSmdyvG-c';

            if (!score) {
                alert("Please enter a valid score.");
                return;
            }

            fetch(`/api/game/${gameId}/set-game-score/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                    event_name: eventName,
                    score: score,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Score submitted successfully:", data);
                alert("Score submitted successfully!");
            })
            .catch(error => {
                console.error("Error submitting score:", error);
                alert("Failed to submit score. Please try again.");
            });
        }
    </script>

</body>
</html>
